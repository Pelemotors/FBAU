{% extends "base.html" %}

{% block title %}×”×ª×—×‘×¨×•×ª ×œ×¤×™×™×¡×‘×•×§{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fab fa-facebook"></i> ×”×ª×—×‘×¨×•×ª ×œ×¤×™×™×¡×‘×•×§
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="fab fa-facebook" style="font-size: 4rem; color: #1877f2;"></i>
                </div>
                
                <h4>×”×ª×—×‘×¨ ×œ×¤×™×™×¡×‘×•×§</h4>
                <p class="text-muted">×¢×œ ×× ×ª ×œ×¤×¨×¡× ×¤×•×¡×˜×™× ×‘×§×‘×•×¦×•×ª, ×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×œ×¤×™×™×¡×‘×•×§</p>
                
                
                 <div id="loginStatus" class="mb-3"></div>
                 
                 <!-- ×˜×¨××™× ×œ ××•×©×§×£ -->
                 <div id="terminalContainer" class="mb-3" style="display: none;">
                     <div class="card">
                         <div class="card-header bg-dark text-white">
                             <i class="fas fa-terminal"></i> ×˜×¨××™× ×œ ×“×©×‘×•×¨×“
                         </div>
                         <div class="card-body bg-dark text-white" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                             <div id="terminalOutput"></div>
                         </div>
                     </div>
                 </div>
                 
                 <button id="loginBtn" class="btn btn-primary btn-lg" onclick="startLogin()">
                     <i class="fab fa-facebook"></i> ×”×ª×—×‘×¨ ×¢×›×©×™×•
                 </button>
                 
                 <!-- ×›×¤×ª×•×¨ ××™×©×•×¨ (××•×¡×ª×¨ ×‘×”×ª×—×œ×”) -->
                 <div id="approvalButtons" class="mt-3" style="display: none;">
                     <button id="approveBtn" class="btn btn-success btn-lg" onclick="approveLogin()">
                         <i class="fas fa-check"></i> ××™×©×•×¨ ×”×ª×—×‘×¨×•×ª
                     </button>
                     <button id="cancelBtn" class="btn btn-danger btn-lg ms-2" onclick="cancelLogin()">
                         <i class="fas fa-times"></i> ×‘×™×˜×•×œ
                     </button>
                 </div>
                
                
                <div class="mt-4">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right"></i> ×—×–×•×¨ ×œ×“×©×‘×•×¨×“
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function startLogin() {
        const loginBtn = document.getElementById('loginBtn');
        const statusDiv = document.getElementById('loginStatus');
        
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××ª×—×‘×¨...';
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> ×“×¤×“×¤×Ÿ ×—×“×© ×™×™×¤×ª×— ×‘×§×¨×•×‘...</div>';
        
        // ×”×ª×—×œ ×ª×”×œ×™×š ×”×ª×—×‘×¨×•×ª
        fetch('/save_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                 if (result.waiting_for_approval) {
                     // ×××ª×™×Ÿ ×œ××™×©×•×¨ ××”×“×£ - ×”×¦×’ ×›×¤×ª×•×¨×™ ××™×©×•×¨
                     statusDiv.innerHTML = `
                         <div class="alert alert-warning">
                             <h6><i class="fas fa-check-circle"></i> ××¦×‘ ×”×ª×—×‘×¨×•×ª ×¤×¢×™×œ!</h6>
                             <p class="mb-0">×”×ª×—×‘×¨ ×‘×¤×™×™×¡×‘×•×§ ×‘×“×¤×“×¤×Ÿ ×•×œ×—×¥ '××™×©×•×¨ ×”×ª×—×‘×¨×•×ª' ×œ××˜×”</p>
                         </div>
                     `;
                     loginBtn.style.display = 'none';
                     
                     // ×”×¦×’ ×›×¤×ª×•×¨×™ ××™×©×•×¨
                     document.getElementById('approvalButtons').style.display = 'block';
                     
                     // ×”×¦×’ ×˜×¨××™× ×œ ××•×©×§×£
                     document.getElementById('terminalContainer').style.display = 'block';
                     
                     // ×”×•×¡×£ ×”×•×“×¢×•×ª ×œ×˜×¨××™× ×œ
                     const terminalOutput = document.getElementById('terminalOutput');
                     terminalOutput.innerHTML = `
                         <div class="text-info">ğŸ”„ ××ª×—×™×œ ×ª×”×œ×™×š ×”×ª×—×‘×¨×•×ª...</div>
                         <div class="text-success">âœ… ×“×¤×“×¤×Ÿ × ×¤×ª×— ×œ×”×ª×—×‘×¨×•×ª</div>
                         <div class="text-warning">ğŸ”” ×”××©×ª××© ×™×›×•×œ ×œ×”×ª×—×‘×¨ ×›×¢×ª ×‘×“×¤×“×¤×Ÿ</div>
                         <div class="text-info">ğŸ“ ×œ×—×¥ '××™×©×•×¨ ×”×ª×—×‘×¨×•×ª' ×œ××˜×” ×œ××—×¨ ×”×”×ª×—×‘×¨×•×ª</div>
                     `;
                     
                    
                    // ×‘×“×•×§ ×›×œ 2 ×©× ×™×•×ª ×× ×”×”×ª×—×‘×¨×•×ª ×”×•×©×œ××”
                    const checkInterval = setInterval(() => {
                        fetch('/check_login_complete')
                            .then(response => response.json())
                            .then(checkResult => {
                                if (checkResult.success && checkResult.completed) {
                                    clearInterval(checkInterval);
                                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ×”×ª×—×‘×¨×•×ª ×”×•×©×œ××” ×‘×”×¦×œ×—×”!</div>';
                                    setTimeout(() => {
                                        window.location.href = '/';
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.log('×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”×ª×—×‘×¨×•×ª:', error);
                            });
                    }, 2000);
                    
                } else {
                    // ×”×ª×—×‘×¨×•×ª ×”×•×©×œ××” - ×—×–×•×¨ ×œ×“×©×‘×•×¨×“
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + result.message + '</div>';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } else {
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + result.message + '</div>';
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-facebook"></i> ×”×ª×—×‘×¨ ×¢×›×©×™×•';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ×©×’×™××”: ' + error.message + '</div>';
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fab fa-facebook"></i> ×”×ª×—×‘×¨ ×¢×›×©×™×•';
        });
    }

    function approveLogin() {
        const approveBtn = document.getElementById('approveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const statusDiv = document.getElementById('loginStatus');
        const terminalOutput = document.getElementById('terminalOutput');
        
        approveBtn.disabled = true;
        cancelBtn.disabled = true;
        approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×××©×¨...';
        
        // ×”×•×¡×£ ×”×•×“×¢×” ×œ×˜×¨××™× ×œ
        terminalOutput.innerHTML += '<div class="text-success">âœ… ××™×©×•×¨ ×”×ª×—×‘×¨×•×ª × ×©×œ×—...</div>';
        
        fetch('/approve_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                terminalOutput.innerHTML += '<div class="text-success">âœ… ' + result.message + '</div>';
                statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + result.message + '</div>';
            } else {
                terminalOutput.innerHTML += '<div class="text-danger">âŒ ' + result.message + '</div>';
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + result.message + '</div>';
                approveBtn.disabled = false;
                cancelBtn.disabled = false;
                approveBtn.innerHTML = '<i class="fas fa-check"></i> ××™×©×•×¨ ×”×ª×—×‘×¨×•×ª';
            }
        })
        .catch(error => {
            terminalOutput.innerHTML += '<div class="text-danger">âŒ ×©×’×™××”: ' + error.message + '</div>';
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ×©×’×™××”: ' + error.message + '</div>';
            approveBtn.disabled = false;
            cancelBtn.disabled = false;
            approveBtn.innerHTML = '<i class="fas fa-check"></i> ××™×©×•×¨ ×”×ª×—×‘×¨×•×ª';
        });
    }

    function cancelLogin() {
        const statusDiv = document.getElementById('loginStatus');
        const terminalOutput = document.getElementById('terminalOutput');
        
        terminalOutput.innerHTML += '<div class="text-warning">âŒ ×”×ª×—×‘×¨×•×ª ×‘×•×˜×œ×” ×¢×œ ×™×“×™ ×”××©×ª××©</div>';
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> ×”×ª×—×‘×¨×•×ª ×‘×•×˜×œ×”</div>';
        
        // ×”×—×–×¨ ×œ××¦×‘ ×”×ª×—×œ×ª×™
        document.getElementById('approvalButtons').style.display = 'none';
        document.getElementById('terminalContainer').style.display = 'none';
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('loginBtn').disabled = false;
        document.getElementById('loginBtn').innerHTML = '<i class="fab fa-facebook"></i> ×”×ª×—×‘×¨ ×¢×›×©×™×•';
    }

</script>
{% endblock %}
