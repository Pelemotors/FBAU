{% extends "base.html" %}

{% block title %}התחברות לפייסבוק{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fab fa-facebook"></i> התחברות לפייסבוק
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="fab fa-facebook" style="font-size: 4rem; color: #1877f2;"></i>
                </div>
                
                <h4>התחבר לפייסבוק</h4>
                <p class="text-muted">על מנת לפרסם פוסטים בקבוצות, עליך להתחבר תחילה לפייסבוק</p>
                
                
                 <div id="loginStatus" class="mb-3"></div>
                 
                 <!-- טרמינל מושקף -->
                 <div id="terminalContainer" class="mb-3" style="display: none;">
                     <div class="card">
                         <div class="card-header bg-dark text-white">
                             <i class="fas fa-terminal"></i> טרמינל דשבורד
                         </div>
                         <div class="card-body bg-dark text-white" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                             <div id="terminalOutput"></div>
                         </div>
                     </div>
                 </div>
                 
                 <button id="loginBtn" class="btn btn-primary btn-lg" onclick="startLogin()">
                     <i class="fab fa-facebook"></i> התחבר עכשיו
                 </button>
                 
                 <!-- כפתור אישור (מוסתר בהתחלה) -->
                 <div id="approvalButtons" class="mt-3" style="display: none;">
                     <button id="approveBtn" class="btn btn-success btn-lg" onclick="approveLogin()">
                         <i class="fas fa-check"></i> אישור התחברות
                     </button>
                     <button id="cancelBtn" class="btn btn-danger btn-lg ms-2" onclick="cancelLogin()">
                         <i class="fas fa-times"></i> ביטול
                     </button>
                 </div>
                
                
                <div class="mt-4">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right"></i> חזור לדשבורד
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function startLogin() {
        const loginBtn = document.getElementById('loginBtn');
        const statusDiv = document.getElementById('loginStatus');
        
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מתחבר...';
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> דפדפן חדש ייפתח בקרוב...</div>';
        
        // התחל תהליך התחברות
        fetch('/save_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                 if (result.waiting_for_approval) {
                     // ממתין לאישור מהדף - הצג כפתורי אישור
                     statusDiv.innerHTML = `
                         <div class="alert alert-warning">
                             <h6><i class="fas fa-check-circle"></i> מצב התחברות פעיל!</h6>
                             <p class="mb-0">התחבר בפייסבוק בדפדפן ולחץ 'אישור התחברות' למטה</p>
                         </div>
                     `;
                     loginBtn.style.display = 'none';
                     
                     // הצג כפתורי אישור
                     document.getElementById('approvalButtons').style.display = 'block';
                     
                     // הצג טרמינל מושקף
                     document.getElementById('terminalContainer').style.display = 'block';
                     
                     // הוסף הודעות לטרמינל
                     const terminalOutput = document.getElementById('terminalOutput');
                     terminalOutput.innerHTML = `
                         <div class="text-info">🔄 מתחיל תהליך התחברות...</div>
                         <div class="text-success">✅ דפדפן נפתח להתחברות</div>
                         <div class="text-warning">🔔 המשתמש יכול להתחבר כעת בדפדפן</div>
                         <div class="text-info">📝 לחץ 'אישור התחברות' למטה לאחר ההתחברות</div>
                     `;
                     
                    
                    // בדוק כל 2 שניות אם ההתחברות הושלמה
                    const checkInterval = setInterval(() => {
                        fetch('/check_login_complete')
                            .then(response => response.json())
                            .then(checkResult => {
                                if (checkResult.success && checkResult.completed) {
                                    clearInterval(checkInterval);
                                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> התחברות הושלמה בהצלחה!</div>';
                                    setTimeout(() => {
                                        window.location.href = '/';
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.log('בדיקת סטטוס התחברות:', error);
                            });
                    }, 2000);
                    
                } else {
                    // התחברות הושלמה - חזור לדשבורד
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + result.message + '</div>';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } else {
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + result.message + '</div>';
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-facebook"></i> התחבר עכשיו';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> שגיאה: ' + error.message + '</div>';
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fab fa-facebook"></i> התחבר עכשיו';
        });
    }

    function approveLogin() {
        const approveBtn = document.getElementById('approveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const statusDiv = document.getElementById('loginStatus');
        const terminalOutput = document.getElementById('terminalOutput');
        
        approveBtn.disabled = true;
        cancelBtn.disabled = true;
        approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מאשר...';
        
        // הוסף הודעה לטרמינל
        terminalOutput.innerHTML += '<div class="text-success">✅ אישור התחברות נשלח...</div>';
        
        fetch('/approve_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                terminalOutput.innerHTML += '<div class="text-success">✅ ' + result.message + '</div>';
                statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + result.message + '</div>';
            } else {
                terminalOutput.innerHTML += '<div class="text-danger">❌ ' + result.message + '</div>';
                statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + result.message + '</div>';
                approveBtn.disabled = false;
                cancelBtn.disabled = false;
                approveBtn.innerHTML = '<i class="fas fa-check"></i> אישור התחברות';
            }
        })
        .catch(error => {
            terminalOutput.innerHTML += '<div class="text-danger">❌ שגיאה: ' + error.message + '</div>';
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> שגיאה: ' + error.message + '</div>';
            approveBtn.disabled = false;
            cancelBtn.disabled = false;
            approveBtn.innerHTML = '<i class="fas fa-check"></i> אישור התחברות';
        });
    }

    function cancelLogin() {
        const statusDiv = document.getElementById('loginStatus');
        const terminalOutput = document.getElementById('terminalOutput');
        
        terminalOutput.innerHTML += '<div class="text-warning">❌ התחברות בוטלה על ידי המשתמש</div>';
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> התחברות בוטלה</div>';
        
        // החזר למצב התחלתי
        document.getElementById('approvalButtons').style.display = 'none';
        document.getElementById('terminalContainer').style.display = 'none';
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('loginBtn').disabled = false;
        document.getElementById('loginBtn').innerHTML = '<i class="fab fa-facebook"></i> התחבר עכשיו';
    }

</script>
{% endblock %}
